<!doctype HTML>
<html>
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://d3js.org/d3.v6.js"></script>
    <script>
        AFRAME.registerComponent('model-opacity', {
            schema: {default: 1.0},
            init: function () {
                this.el.addEventListener('model-loaded', this.update.bind(this));
            },
            update: function () {
                var mesh = this.el.getObject3D('mesh');
                var data = this.data;
                if (!mesh) {
                    return;
                }
                mesh.traverse(function (node) {
                    if (node.isMesh) {
                        node.material.opacity = data;
                        node.material.transparent = data < 1.0;
                        node.material.needsUpdate = true;
                    }
                });
            }
        });

        AFRAME.registerComponent('video', {
            init: function () {
                document.querySelector("#video").pause();

                document.querySelector("#videoPanel").addEventListener('click', () => {
                    console.log("video clicked");
                    if (document.querySelector("#video").paused) {
                        document.querySelector("#video").play();
                    } else {

                        document.querySelector("#video").pause();
                    }
                })
            },
        });

        AFRAME.registerComponent('clickhandler', {
            init: function () {
                document.querySelector("#videoButton").addEventListener('click', () => {
                    console.log("button clicked");
                    window.open("https://www.ubs.com/global/en/investment-bank/research-academy.html", "_blank");
                });
            }
        });

        AFRAME.registerComponent('animated', {
            init: function () {
                document.querySelector("#video").addEventListener("ended", () => {
                    // this.el.emit("videoFinished");
                });
                document.querySelector("#video").addEventListener("play", () => {
                    this.el.emit("videoPlayed");
                });
                document.querySelector("#video").addEventListener("pause", () => {
                    this.el.emit("videoPaused");
                });
            }
        });

        AFRAME.registerComponent('group-opacity', {
            schema: {opacity: {default: 1.0}},
            update: function () {
                var opacity = this.data.opacity;
                var children = [].slice.call(this.el.children);
                children
                    .filter(function (child) {
                        return child.hasAttribute('material') || child.hasAttribute('group-opacity');
                    })
                    .forEach(function (child) {
                        child.setAttribute('material', "opacity: " + opacity);
                        child.setAttribute('group-opacity', "opacity: " + opacity);
                    });
            }
        });

        AFRAME.registerComponent('graph', {
            init: function () {

                var data = d3.range(10).map(function (d, i) {
                    return {v: i / 10}
                });

                setInterval(() => update(data, ""), 5000);
                update(data, "");
            }
        });

        AFRAME.registerComponent('graph2', {
            init: function () {
                var data = d3.range(10).map(function (d, i) {
                    return {v: Math.random()}
                });

                setInterval(() => {
                    data = d3.range(10).map(function (d, i) {
                        return {v: Math.random()}
                    });
                    update(data, "2")
                }, 5000);
                update(data, "2");
            }
        });

        AFRAME.registerComponent('graph4', {
            init: function () {

                var data = d3.range(10).map(function (d, i) {
                    return {v: Math.random()}
                });

                setInterval(() => update(data, "4"), 5000);
                update(data, "4");
            }
        });

        AFRAME.registerComponent('graph3', {
            init: function () {
                setInterval(getEthPrice, 60000);
                getEthPrice();
            }
        });

        function getEthPrice() {
            fetch("https://min-api.cryptocompare.com/data/v2/histominute?fsym=ETH&tsym=GBP&limit=10").then(data => {
                data.json().then(res => {
                    let points = (res.Data.Data.map(data => {
                        return {v: data.open}
                    }));
                    update(points, "3");
                })
            });
        }

        function update(data, modifier) {
            d3.select('#bars' + modifier).selectAll('a-entity').remove();

            var entities = d3.select('#bars' + modifier)
                .selectAll('a-entity')
                .data(data);

            var newobj = entities.enter()
                .append('a-entity')
                .attr('position', function (d, i) {
                    var a = 2 / data.length;
                    return a * i - 1 + ' -0.5 0'
                })
                .attr('group-opacity', d3.select('#bars' + modifier).attr('group-opacity'));

            // appending a box within each entity
            newobj.append('a-box')
                .attr('color', 'red')
                .attr('width', 0.2)
                .attr('height', function (d, i) {
                    return modifier === "3" ? d.v - data[0].v : d.v;
                })
                .attr('depth', 0.5)
                .attr('position', function (d, i) {
                    return '0 ' + (modifier === "3" ? ((d.v - data[0].v) / 2) : (d.v / 2)) + ' 0'
                })
                .attr('material', d3.select('#bars' + modifier).attr('group-opacity'));

            // update height of each box
            entities.select('a-box')
                .attr('height', function (d, i) {
                    return d.v
                });

            newobj.append('a-text')
                .attr('value', function (d) {
                    return parseInt(d.v * 10)
                })
                .attr('color', 'black')
                .attr('position', function (d) {
                    return '0 1.5 0'
                })
                .attr('visible', false);

            entities.on('mouseenter', function () {
                d3.select(this)
                    .select('a-text')
                    .attr('visible', true)
            });

            entities.on('mouseleave', function () {
                d3.select(this)
                    .select('a-text')
                    .attr('visible', false)
            });
        }
    </script>
</head>
<body>
<a-scene webxr="requiredFeatures: local-floor;">
    <a-assets>
        <img id="keys" src="/unitywebar/assets/UBS-LogoKEYS.png"/>
        <img id="UBSText" src="/unitywebar/assets/UBS-LogoTEXT.png"/>
        <a-asset-item id="UBSKeysModel" src="/unitywebar/assets/UBS-LogoKEYS.obj"></a-asset-item>
        <a-asset-item id="UBSKeysMaterial" src="/unitywebar/assets/UBS-LogoKEYS.mtl"></a-asset-item>
        <video id="video" src="/unitywebar/assets/intro_movie.mp4#t=0.5" crossorigin playsinline controls></video>
        <video id="video2" src="/unitywebar/assets/intro_movie.mp4#t=0.5" crossorigin playsinline controls></video>
        <video id="video3" src="/unitywebar/assets/intro_movie.mp4#t=0.5" crossorigin playsinline controls></video>
        <video id="video4" src="/unitywebar/assets/intro_movie.mp4#t=0.5" crossorigin playsinline controls></video>
        <video id="video5" src="/unitywebar/assets/intro_movie.mp4#t=0.5" crossorigin playsinline controls></video>
    </a-assets>
    <a-sky color="#FFFFFF"></a-sky>
    <a-entity cursor="fuse: false; rayOrigin: mouse;" raycaster="objects: .intersectable; useWorldCoordinates: true;">
    </a-entity>
    <a-entity animated obj-model="obj: #UBSKeysModel; mtl: #UBSKeysMaterial;" rotation="90 0 0" width="0.2" height="0.2"
              depth="0.2" position="0.125 2 -4"
              scale="0 0 0" model-opacity="1"
              animation__keys_zoom_in="property: scale; from: 0 0 0; to: 0.0008 0.0008 0.0008; dur: 1500; easing: linear;"
              animation__keys_move_left="property: position; from: 0.125 2 -4; to: -0.35 2 -4; dur: 750; delay: 250; easing: linear; startEvents: animationcomplete__keys_zoom_in;"
              animation__keys_fadeout="property: model-opacity; from: 1.0; to: 0.0; dur: 1000; delay: 2000; startEvents: animationcomplete__keys_move_left;"
              animation__keys_disapear="property: scale; from: 0.0008 0.0008 0.0008; to: 0 0 0; dur: 1; easing: linear; startEvents: animationcomplete__keys_fadeout;"
              animation__keys_relocated="property: position; from: -0.35 2 -4; to: 0 2 -4; dur: 1; easing: linear; startEvents: animationcomplete__keys_fadeout;"
              animation__keys_reapear="property: scale; from: 0 0 0; to: 0.0008 0.0008 0.0008; dur: 1; easing: linear; delay: 3000; startEvents: videoFinished;"
              animation__keys_fadein="property: model-opacity; from: 0; to: 1; dur: 3000; delay: 3000; startEvents: videoFinished;">
    </a-entity>
    <a-image animated src="#UBSText" rotation="0 0 0" width="0.6" height="0.3" depth="0.3" position="0.1 2 -4"
             material="opacity: 0;"
             animation__logotext_fadein="property: components.material.material.opacity; from: 0; to: 1; dur: 500; delay: 2500;"
             animation__logotext_fadeout="property: components.material.material.opacity; from: 1; to: 0; dur: 1000; delay: 2000; startEvents: animationcomplete__logotext_fadein;"
             animation__logotext_disapear="property: scale; from: 1 1 1; to: 0 0 0; dur: 1; easing: linear; startEvents: animationcomplete__logotext_fadeout;">
        <a-text animated value="Research Academy" color="black" position="-0.65 -0.3 0" opacity="0"
                animation__text_fadein="property: text.opacity; from: 0; to: 1; dur: 500; delay: 2500;"
                animation__text_fadeout="property: text.opacity; from: 1; to: 0; dur: 1000; delay: 2000; startEvents: animationcomplete__text_fadein;"
                animation__text_disapear="property: scale; from: 1 1 1; to: 0 0 0; dur: 1; easing: linear; startEvents: animationcomplete__text_fadeout;"
                scale="0.5 0.5 0.5">
        </a-text>
    </a-image>
    <a-video animated id="videoPanel" video rotation="0 0 0" src="#video" width="2" height="1.125"
             position="0 2 -4" material="opacity: 0;" class="intersectable"
             animation__video_fadein="property: components.material.material.opacity; from: 0; to: 1; dur: 3000; delay: 6000;"
             animation__video_fadeout="property: components.material.material.opacity; from: 1; to: 0; dur: 3000; startEvents: videoFinished;"
             animation__video_disapear="property: scale; from: 1 1 1; to: 0 0 0; dur: 1; easing: linear; startEvents: animationcomplete__video_fadeout;">
        <a-triangle rotation="0 0 -90" scale="0 0 0" position="0 0 0.1"
                    animated color="#000000"
                    animation__videosymbol_fadein_time="property: scale; from: 0 0 0; to: 0.4 0.4 0.4; dur: 250; delay: 6000;"
                    animation__videosymbol_fadein="property: scale; from: 0 0 0; to: 0.4 0.4 0.4; dur: 250; startEvents: videoPaused;"
                    animation__videosymbol_fadeout="property: scale; from: 0.4 0.4 0.4; to: 0 0 0; dur: 250; startEvents: videoPlayed;"
        ></a-triangle>
    </a-video>
    <a-plane clickhandler class="intersectable" animated id="videoButton" color="white" rotation="0 0 0"
             position="0 1 -4" width="2" height="0.5"
             material="transparent: true; opacity: 0;"
             animation__button_fadein="property: components.material.material.opacity; from: 0; to: 1; dur: 3000; delay: 16000;"
             animation__button_move="property: position; from: 0 1 -4; to: 0 1 -4; dur: 2500; delay: 500; startEvents: videoFinished;">
        <a-text animated id="videoButtonText" value="Click Here to Find Out More" color="black"
                position="-0.75 0 0.05" scale="0.5 0.5 0.5" opacity="0"
                animation__buttontext_fadein="property: text.opacity; from: 0; to: 1; dur: 6000; delay: 16000;">
        </a-text>
    </a-plane>
    <a-entity animated graph id="bars" group-opacity="opacity: 0" rotation="0 -20 0" width="2" height="1.125"
              position="3 2 -3.5" material="opacity: 0;" class="intersectable"
              animation__video_fadein="property: group-opacity.opacity; from: 0; to: 1; dur: 3000; delay: 6000;"
              animation__video_fadeout="property: group-opacity.opacity; from: 1; to: 0; dur: 3000; startEvents: videoFinished2;"
              animation__video_disapear="property: scale; from: 1 1 1; to: 0 0 0; dur: 1; easing: linear; startEvents: animationcomplete__video_fadeout;">
    </a-entity>
    <a-entity animated graph2 id="bars2" group-opacity="opacity: 0" rotation="0 20 0" width="2" height="1.125"
              position="-3 2 -3.5" material="opacity: 0;" class="intersectable"
              animation__video_fadein="property: group-opacity.opacity; from: 0; to: 1; dur: 3000; delay: 6000;"
              animation__video_fadeout="property: group-opacity.opacity; from: 1; to: 0; dur: 3000; startEvents: videoFinished3;"
              animation__video_disapear="property: scale; from: 1 1 1; to: 0 0 0; dur: 1; easing: linear; startEvents: animationcomplete__video_fadeout;">
    </a-entity>
    <a-entity animated graph3 id="bars3" group-opacity="opacity: 0" rotation="0 45 0" width="2" height="1.125"
              position="-5 2 -2" material="opacity: 0;" class="intersectable"
              animation__video_fadein="property: group-opacity.opacity; from: 0; to: 1; dur: 3000; delay: 6000;"
              animation__video_fadeout="property: group-opacity.opacity; from: 1; to: 0; dur: 3000; startEvents: videoFinished4;"
              animation__video_disapear="property: scale; from: 1 1 1; to: 0 0 0; dur: 1; easing: linear; startEvents: animationcomplete__video_fadeout;">
    </a-entity>
    <a-entity animated graph4 id="bars4" group-opacity="opacity: 0" rotation="0 -45 0" width="2" height="1.125"
              position="5 2 -2" material="opacity: 0;" class="intersectable"
              animation__video_fadein="property: group-opacity.opacity; from: 0; to: 1; dur: 3000; delay: 6000;"
              animation__video_fadeout="property: group-opacity.opacity; from: 1; to: 0; dur: 3000; startEvents: videoFinished5;"
              animation__video_disapear="property: scale; from: 1 1 1; to: 0 0 0; dur: 1; easing: linear; startEvents: animationcomplete__video_fadeout;">
    </a-entity>
</a-scene>
</body>
</html>
