<!doctype HTML>
<html>
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/2.0.5/aframe/build/aframe-ar.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://unpkg.com/d3-3d/build/d3-3d.min.js"></script>
</head>
<body style='margin : 0px; overflow: scroll;'>
<a-scene embedded arjs='patternRatio: 0.75; debugUIEnabled: false;'>
    <a-asset-item id="mozilla" src="https://raw.githubusercontent.com/luiguild/aframe-svg-extruder/master/example/svg/mozilla-letters.svg"></a-asset-item>
    <a-assets>
        <img id="feature" src="/webar/assets/image001.jpeg" crossorigin="anonymous">
        <img id="research" src="/webar/assets/image002.jpeg" crossorigin="anonymous">
        <video id="video" src="/webar/assets/video01.mp4" loop="true" crossorigin webkit-playsinline playsinline
               controls></video>
    </a-assets>
    <a-entity camera>
          <a-svg
            src="#mozilla"
            proportional-scale="2"
            extrude="0.5"
            z-factor="0"
            position="0 1.3 -5"
          >
        <a-marker type='pattern' url='/webar/pattern-happy.patt' id='marker' emitevents='true'
                  cursor='rayOrigin: mouse'>
            <a-box src="" id="Cube_0" class="intersectable" width="0.1" height="0.1" depth="0.1" position="0.283 0.32 0" rotation="0 0 0" color="#FFFFFF" transparent=False
            animation__cube_0_f0="property: position;  to: 0 0.32 0; dur: 0; easing: linear; "
            animation__cube_0_f0="property: rotation;  to: 0 0 0; dur: 0; easing: linear; "
            animation__cube_0_f0="property: width;  to: 0.1; dur: 0; easing: linear; "
            animation__cube_0_f0="property: height;  to: 0.1; dur: 0; easing: linear; "
            animation__cube_0_f0="property: depth;  to: 0.1; dur: 0; easing: linear; "
            animation__cube_0_f1="property: position; from: 0 0.32 0; to: -0.435 0.32 0; dur: 60000; easing: linear; startEvents: animationcomplete__cube_0_f0;"
            animation__cube_0_f2="property: position; from: -0.435 0.32 0; to: 0.283 0.32 0; dur: 0; easing: linear; startEvents: animationcomplete__cube_0_f1;"
            ></a-box>
        </a-marker>
        </entity>
</a-scene>
<svg width="960" height="500"></svg>
<script>

    var origin = [480, 250], j = 16, points = [], alpha = 0, beta = 0, startAngle = Math.PI/4;
    var svg    = d3.select('svg').call(d3.drag().on('drag', dragged).on('start', dragStart).on('end', dragEnd)).append('g');
    var mx, my, mouseX, mouseY;

    var surface = d3._3d()
        .scale(10)
        .x(function(d){ return d.x; })
        .y(function(d){ return d.y; })
        .z(function(d){ return d.z; })
        .origin(origin)
        .rotateY(startAngle)
        .rotateX(-startAngle)
        .shape('SURFACE', j*2);

    var color = d3.scaleLinear();

    function processData(data, tt){

        var planes = svg.selectAll('path').data(data, function(d){ return d.plane; });

        planes
            .enter()
            .append('path')
            .attr('class', '_3d')
            .attr('fill', colorize)
            .attr('opacity', 0)
            .attr('stroke-opacity', 0.1)
            .merge(planes)
            .attr('stroke', 'black')
            .transition().duration(tt)
            .attr('opacity', 1)
            .attr('fill', colorize)
            .attr('d', surface.draw);

        planes.exit().remove();

        d3.selectAll('._3d').sort(surface.sort);

    }

    function colorize(d){
        var _y = (d[0].y + d[1].y + d[2].y + d[3].y)/4;
        return d.ccw ? d3.interpolateSpectral(color(_y)) : d3.color(d3.interpolateSpectral(color(_y))).darker(2.5);
    }

    function dragStart(){
        mx = d3.event.x;
        my = d3.event.y;
    }

    function dragged(){
        mouseX = mouseX || 0;
        mouseY = mouseY || 0;
        beta   = (d3.event.x - mx + mouseX) * Math.PI / 230 ;
        alpha  = (d3.event.y - my + mouseY) * Math.PI / 230  * (-1);
        processData(surface.rotateY(beta + startAngle).rotateX(alpha - startAngle)(points), 0);
    }

    function dragEnd(){
        mouseX = d3.event.x - mx + mouseX;
        mouseY = d3.event.y - my + mouseY;
    }

    function init(eq){
        points = [];

        for(var z = -j; z < j; z++){
            for(var x = -j; x < j; x++){
                points.push({x: x, y: eq(x, z), z: z});
            }
        }

        var yMin = d3.min(points, function(d){ return d.y; });
        var yMax = d3.max(points, function(d){ return d.y; });

        color.domain([yMin, yMax]);
        processData(surface(points), 1000);
    }

    function change(){
        var rn1 = Math.floor(d3.randomUniform(1, 12)());
        var eqa = function(x, z){
            return Math.cos(Math.sqrt(x*x+z*z)/5*Math.PI)*rn1;
        };
        init(eqa);
    }

    d3.selectAll('button').on('click', change);

    change();

</script>
</body>
</html>
