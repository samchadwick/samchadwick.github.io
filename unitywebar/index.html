<!doctype HTML>
<html>
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/2.0.5/aframe/build/aframe-ar.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://unpkg.com/d3-3d/build/d3-3d.min.js"></script>
    <script>

        // Get the URL parameter to identify the individual
        // Let's assume that the parameter is passed as the variable userID via GET in the URL, so we only need one ARsite
        const urlParams = new URLSearchParams(window.location.search);
        const userID = urlParams.get('userId');
        let patternFile = undefined;
        if (userID) {
            patternFile = '/webar/params/' + userID + '.patt';
        }

        async function getUser(source) {
            let r = fetch(source)
                .then(response => response.json())
                .catch((err) => {
                    console.log(err.message);
                });
            return await r;
        }

        // Get the Feed
        async function getFeed(source) {
            let r = fetch(source, {
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow-Headers": "*"
                }
            })
                .then(response => response.text())
                .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
                .catch((err) => {
                    console.log(err.message);
                });
            return await r;
        }

        // Update the text items with the stories and links
        async function buildStories(feed) {
            const feedArray = await getFeed(feed);
            const items = feedArray.querySelectorAll("item");
            var i = 1;
            for (const each of items) {
                // Set text
                var title = await each.querySelector("title").innerHTML.replace("<![CDATA[", "").replace("]]>", "");
                document.getElementById("item" + i).setAttribute('value', title);
                // Set link
                var target = document.querySelector("#link" + i);
                target.addEventListener('click', async function () {
                    var link = await each.querySelector("link").innerHTML;
                    window.open(link, '_blank');
                });
                i++;
                if (i > 5) {
                    break;
                }
            }
        }

        // Register components
        i = 1;
        while (i < 6) {
            AFRAME.registerComponent('item' + i, {
                init: function () {
                    this.el.setAttribute('value', 'Loading RSS Feed...');
                }
            });
            i++;
        }

        AFRAME.registerComponent('feature', {
            init: function () {
                this.el.addEventListener('click', (e) => {
                    window.open(this.data.url, '_blank');
                })
            }
        });

        AFRAME.registerComponent('research', {
            init: function () {
                this.el.addEventListener('click', (e) => {
                    window.open(this.data.url, '_blank');
                })
            }
        });

        AFRAME.registerComponent('video', {
            init: function () {
                this.toggle = false;
                document.querySelector("#video").pause();

                document.querySelector("#videoPanel").addEventListener('click', () => {
                    if (!this.toggle) {
                        this.toggle = true;
                        document.querySelector("#video").play();
                    } else {
                        this.toggle = false;
                        document.querySelector("#video").pause();
                    }
                })
            },
        });

    </script>
</head>
<body style='margin : 0px; overflow: scroll;'>
<a-scene embedded arjs='patternRatio: 0.75; debugUIEnabled: false;'>
    <a-asset-item id="mozilla" src="https://raw.githubusercontent.com/luiguild/aframe-svg-extruder/master/example/svg/mozilla-letters.svg"></a-asset-item>
    <a-assets>
        <img id="feature" src="/webar/assets/image001.jpeg" crossorigin="anonymous">
        <img id="research" src="/webar/assets/image002.jpeg" crossorigin="anonymous">
        <video id="video" src="/webar/assets/video01.mp4" loop="true" crossorigin webkit-playsinline playsinline
               controls></video>
    </a-assets>
    <a-entity camera>
          <a-svg
            src="#mozilla"
            proportional-scale="2"
            extrude="0.5"
            z-factor="0"
            position="0 1.3 -5"
          >
        <a-marker type='pattern' url='/webar/pattern-happy.patt' id='marker' emitevents='true'
                  cursor='rayOrigin: mouse'>
            <a-box src="" id="Cube_0" class="intersectable" width="0.1" height="0.1" depth="0.1" position="0.283 0.32 0" rotation="0 0 0" color="#FFFFFF" transparent=False
            animation__cube_0_f0="property: position;  to: 0 0.32 0; dur: 0; easing: linear; "
            animation__cube_0_f0="property: rotation;  to: 0 0 0; dur: 0; easing: linear; "
            animation__cube_0_f0="property: width;  to: 0.1; dur: 0; easing: linear; "
            animation__cube_0_f0="property: height;  to: 0.1; dur: 0; easing: linear; "
            animation__cube_0_f0="property: depth;  to: 0.1; dur: 0; easing: linear; "
            animation__cube_0_f1="property: position; from: 0 0.32 0; to: -0.435 0.32 0; dur: 60000; easing: linear; startEvents: animationcomplete__cube_0_f0;"
            animation__cube_0_f2="property: position; from: -0.435 0.32 0; to: 0.283 0.32 0; dur: 0; easing: linear; startEvents: animationcomplete__cube_0_f1;"
            ></a-box>
        </a-marker>
        </entity>
</a-scene>
<script>
    // // Workaround for an AR.js bug (https://github.com/jeromeetienne/AR.js/issues/410)
    // const sceneEl = document.querySelector('a-scene');
    // sceneEl.addEventListener('loaded', () => {
    //     sceneEl.camera = new THREE.PerspectiveCamera();
    // });
</script>
<script>
    if (patternFile) {
        const original = document.getElementById('marker');
        let marker = original.cloneNode(true);
        marker.id = "marker2";
        marker.setAttribute("url", patternFile);

        original.parentNode.insertBefore(marker, original);
        console.log(document.getElementById('marker').parentNode);
    }

    // Get the User Preferences
    async function getPrefs(userID) {
        // We cannot call to the Admin System so we will call to a static set of parameters instead
        // const id_url = 'https://cors-anywhere.herokuapp.com/https://raw.githubusercontent.com/willnnotdan/team57/master/arsite/dummy-params.json';
        let id_url = '/webar/params/' + userID + '.json';
        if (!userID) {
            id_url = '/webar/params/params.json';
        }
        const res = await getUser(id_url);
        console.log(res);

        fetch(res.articles[0]).then(resp => {
            resp.json().then(result => {
                document.getElementById("article1Title").setAttribute("value", result.heading);
                document.getElementById("article1Text").setAttribute("value", result.text);
                document.getElementById("research").setAttribute("src", result.image);
            });
        }).catch(err => {});

        fetch(res.articles[1]).then(resp => {
            resp.json().then(result => {
                document.getElementById("article2Title").setAttribute("value", result.heading);
                document.getElementById("article2Text").setAttribute("value", result.text);
                document.getElementById("feature").setAttribute("src", result.image);
            });
        }).catch(err => {});
        // update the Assets
        document.getElementById("video").setAttribute("src", res.videos[0]);
        document.getElementById("emailPlane").addEventListener('click', () => {
            window.open("mailto:" + res.user.email, '_blank');
        });

        document.getElementById("website").addEventListener('click', () => {
            window.open(res.website, "_blank");
        });

        document.getElementById("websiteName").setAttribute("value", res.websiteName);

        var feed = res.rss[0];
        buildStories(feed);
    }

    getPrefs(userID); // Uncomment this when URL available
</script>
<svg width="960" height="500"></svg>
<script>

    var origin = [480, 250], j = 16, points = [], alpha = 0, beta = 0, startAngle = Math.PI/4;
    var svg    = d3.select('svg').call(d3.drag().on('drag', dragged).on('start', dragStart).on('end', dragEnd)).append('g');
    var mx, my, mouseX, mouseY;

    var surface = d3._3d()
        .scale(10)
        .x(function(d){ return d.x; })
        .y(function(d){ return d.y; })
        .z(function(d){ return d.z; })
        .origin(origin)
        .rotateY(startAngle)
        .rotateX(-startAngle)
        .shape('SURFACE', j*2);

    var color = d3.scaleLinear();

    function processData(data, tt){

        var planes = svg.selectAll('path').data(data, function(d){ return d.plane; });

        planes
            .enter()
            .append('path')
            .attr('class', '_3d')
            .attr('fill', colorize)
            .attr('opacity', 0)
            .attr('stroke-opacity', 0.1)
            .merge(planes)
            .attr('stroke', 'black')
            .transition().duration(tt)
            .attr('opacity', 1)
            .attr('fill', colorize)
            .attr('d', surface.draw);

        planes.exit().remove();

        d3.selectAll('._3d').sort(surface.sort);

    }

    function colorize(d){
        var _y = (d[0].y + d[1].y + d[2].y + d[3].y)/4;
        return d.ccw ? d3.interpolateSpectral(color(_y)) : d3.color(d3.interpolateSpectral(color(_y))).darker(2.5);
    }

    function dragStart(){
        mx = d3.event.x;
        my = d3.event.y;
    }

    function dragged(){
        mouseX = mouseX || 0;
        mouseY = mouseY || 0;
        beta   = (d3.event.x - mx + mouseX) * Math.PI / 230 ;
        alpha  = (d3.event.y - my + mouseY) * Math.PI / 230  * (-1);
        processData(surface.rotateY(beta + startAngle).rotateX(alpha - startAngle)(points), 0);
    }

    function dragEnd(){
        mouseX = d3.event.x - mx + mouseX;
        mouseY = d3.event.y - my + mouseY;
    }

    function init(eq){
        points = [];

        for(var z = -j; z < j; z++){
            for(var x = -j; x < j; x++){
                points.push({x: x, y: eq(x, z), z: z});
            }
        }

        var yMin = d3.min(points, function(d){ return d.y; });
        var yMax = d3.max(points, function(d){ return d.y; });

        color.domain([yMin, yMax]);
        processData(surface(points), 1000);
    }

    function change(){
        var rn1 = Math.floor(d3.randomUniform(1, 12)());
        var eqa = function(x, z){
            return Math.cos(Math.sqrt(x*x+z*z)/5*Math.PI)*rn1;
        };
        init(eqa);
    }

    d3.selectAll('button').on('click', change);

    change();

</script>
</body>
</html>
