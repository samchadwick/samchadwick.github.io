<!doctype HTML>
<html>
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/2.0.5/aframe/build/aframe-ar.js"></script>
    <script>

        // Get the URL parameter to identify the individual
        // Let's assume that the parameter is passed as the variable userID via GET in the URL, so we only need one ARsite
        const urlParams = new URLSearchParams(window.location.search);
        const userID = urlParams.get('userID');

        // Function to Get User Preferences cross-site
        // Cross Site not needed because using Dummy Params for now
        /*
        async function getUser(source) {
            let r = fetch("https://cors-anywhere.herokuapp.com/" + source, {
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow-Headers": "*"
                }
            })
                .then(response => response.text())
                .then(str => new window.DOMParser().parseFromString(str, "json"))
                .catch((err) => {
                    console.log(err.message);
                });
            return await r;
        }
        */

        async function getUser(source) {
            let r = fetch(source)
                .then(response => response.json())
                .catch((err) => {
                    console.log(err.message);
                });
            return await r;
        }

        // Function to Get Feed cross-site
        async function getFeed(source) {
            let r = fetch("https://cors-anywhere.herokuapp.com/" + source, {
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow-Headers": "*"
                }
            })
                .then(response => response.text())
                .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
                .catch((err) => {
                    console.log(err.message);
                });
            return await r;
        }

        // Get the Feed and Update the text items with the stories and links
        async function buildStories(feed) {
            const feedArray = await getFeed(feed);
            const items = feedArray.querySelectorAll("item");
            var i = 1;
            for (const each of items) {
                // Set text
                var title = await each.querySelector("title").innerHTML.replace("<![CDATA[", "").replace("]]>", "");
                console.log(title);
                //var item = document.querySelector("#item" + i);
                //item.setAttribute('value', title);
                document.getElementById("item" + i).setAttribute('value', title);
                // Set link
                var target = document.querySelector("#link" + i);
                target.addEventListener('click', async function () {
                    var link = await each.querySelector("link").innerHTML;
                    window.open(link, '_blank');
                });
                i++;
                if (i > 5) {
                    break;
                }
            }
        }

        // Register components
        i = 1;
        while (i < 6) {
            AFRAME.registerComponent('item' + i, {
                init: function () {
                    // this.el.setAttribute('value', 'Loading RSS Feed...');
                }
            });
            i++;
        }


        // Add link to image
        AFRAME.registerComponent('image1', {
            init: function () {
                this.el.addEventListener('click', (e) => {
                    window.open(this.data.url, '_blank');
                })
            }
        });

        AFRAME.registerComponent('image2', {
            init: function () {
                this.el.addEventListener('click', (e) => {
                    window.open(this.data.url, '_blank');
                })
            }
        });

        AFRAME.registerComponent('image3', {
            init: function () {
                this.el.addEventListener('click', (e) => {
                    window.open(this.data.url, '_blank');
                })
            }
        });

		AFRAME.registerComponent('video1', {
            init: function () {
            	this.toggle = false;
            	document.querySelector("#video1").pause(); //reference to the video
            },
            tick:function(){  
            	if(document.querySelector("a-marker").object3D.visible == true){
            	if(!this.toggle){
            	this.toggle = true;
            	document.querySelector("#video1").play();
            }
            }else{
            	this.toggle = false;
            	document.querySelector("#video1").pause();
            }
  			}
		});
		

    </script>
</head>
<body style='margin : 0px; overflow: scroll;'>
<a-scene embedded arjs='patternRatio: 0.68; debugUIEnabled: false;'>
    <a-assets>
        <img id="image001" url="https://www.ubs.com" crossorigin="anonymous">
        <img id="image002" url="https://www.ubs.com" crossorigin="anonymous">
		<img id="person" src="/business-card/loading.gif" crossorigin="anonymous">
		<video id="video1" autoplay loop="true" src="/business-card/assets/video01.mp4"></video>
    </a-assets>

    <a-entity camera>
        <a-marker type='pattern' url='/business-card/pattern-generic-qr-code.patt' emitevents='true' cursor='rayOrigin: mouse'>

            <!-- Left Column -->

                <!-- Header -->
                <a-plane color="black" rotation="-90 0 0" position="-3.0 -0.2 -3.8" width="2.5" height="0.5"
                         material="transparent: true; opacity: 0.90"></a-plane>
                <a-text value="Contact" color="white" rotation="-90 0 0" position="-3.4 0 -3.8"
                        scale="0.5 0.5 0.5"></a-text>

                <!-- Headshot -->
                <a-image image3="url: https://linkedin.com" src="#person" rotation="-90 0 0" position="-3.0 -0.2 -2.45"
                         width="2.5" height="2"></a-image>

                <!-- Email -->
                <a-plane id="emailPlane" color="white" rotation="-90 0 0" position="-3.0 -0.2 -1.2" width="2.5" height="0.4"
                         material="transparent: true; opacity: 0.90"></a-plane>
                <a-text id="email" value="telami_e@yahoo.com" color="black" rotation="-90 0 0" position="-3.4 0 -1.1"
                        scale="0.5 0.5 0.5"></a-text>

                <!-- Phone -->
                <a-plane color="white" rotation="-90 0 0" position="-3.0 -0.2 -0.8" width="2.5" height="0.4"
                         material="transparent: true; opacity: 0.90"></a-plane>
                <a-text id="phone" value="+44 7510 705 245" color="black" rotation="-90 0 0" position="-3.4 0 -0.9"
                        scale="0.5 0.5 0.5"></a-text>

                <!-- Address -->
                <a-plane color="white" rotation="-90 0 0" position="-3.0 -0.2 -0.6" width="2.5" height="0.4"
                         material="transparent: true; opacity: 0.90"></a-plane>
                <a-text id="address" value="London, UK" color="black" rotation="-90 0 0" position="-3.4 0 -0.7"
						scale="0.5 0.5 0.5"></a-text>

				<a-plane color="black" rotation="-90 0 0" position="-3.0 -0.2 -0.1" width="2.5" height="0.5"
						material="transparent: true; opacity: 0.90"></a-plane>
			   <a-text value="Videos" color="white" rotation="-90 0 0" position="-3.4 0 0"
					   scale="0.5 0.5 0.5"></a-text>
						
				<!-- Video 01 -->
				<a-video video1 rotation="-90 0 0" src="#video1" width="2.5" height="1.5" position="-3.0 0 1.15"></a-video>

            <!-- Center Column -->

            <a-plane color="black" rotation="-90 0 0" position="0 -0.2 -3.8" width="3" height="0.5"
                     material="transparent: true; opacity: 0.90"></a-plane>
            <a-text value="Latest News" color="white" rotation="-90 0 0" position="-1.2 0 -3.8"
                    scale="0.5 0.5 0.5"></a-text>

            <a-plane id="link1" color="white" rotation="-90 0 0" position="0 -0.2 -3.2" width="3" height="0.5"
                     material="transparent: true; opacity: 0.90"></a-plane>
            <a-text item1 id="item1" value="Loading RSS Feed..." color="black" rotation="-90 0 0" position="-1.2 0 -3.2"
                    scale="0.5 0.5 0.5"></a-text>

            <a-plane id="link2" color="white" rotation="-90 0 0" position="0 -0.2 -2.6" width="3" height="0.45"
                     material="transparent: true; opacity: 0.90"></a-plane>
            <a-text item2 id="item2" value="Loading RSS Feed..." color="black" rotation="-90 0 0" position="-1.2 0 -2.6"
                    scale="0.5 0.5 0.5"></a-text>

            <a-plane id="link3" color="white" rotation="-90 0 0" position="0 -0.2 -2" width="3" height="0.5"
                     material="transparent: true; opacity: 0.90"></a-plane>
            <a-text item3 id="item3" value="Loading RSS Feed..." color="black" rotation="-90 0 0" position="-1.2 0 -2"
                    scale="0.5 0.5 0.5"></a-text>

            <a-plane id="link4" color="white" rotation="-90 0 0" position="0 -0.2 -1.4" width="3" height="0.5"
                     material="transparent: true; opacity: 0.90"></a-plane>
            <a-text item4 id="item4" value="Loading RSS Feed..." color="black" rotation="-90 0 0" position="-1.2 0 -1.4"
                    scale="0.5 0.5 0.5"></a-text>

            <a-plane id="link5" color="white" rotation="-90 0 0" position="0 -0.2 -0.8" width="3" height="0.5"
                     material="transparent: true; opacity: 0.90"></a-plane>
            <a-text item5 id="item5" value="Loading RSS Feed..." color="black" rotation="-90 0 0" position="-1.2 0 -0.8"
                    scale="0.5 0.5 0.5"></a-text>

            <a-plane color="black" rotation="-90 0 0" position="0 -0.2 -0.2" width="3" height="0.5"
                     material="transparent: true; opacity: 0.90"></a-plane>
            <a-text value="Featured Articles" color="white" rotation="-90 0 0" position="-1.2 0 -0.2"
					scale="0.5 0.5 0.5"></a-text>

            <a-image image1="url: https://www.ubs.com" src="#image001" rotation="-90 0 0" position="0 -0.2 1.15"
                     width="3" height="2"></a-image>

            <a-plane color="white" rotation="-90 0 0" position="0 -0.2 2.55" width="3" height="0.7"
                     material="transparent: true; opacity: 0.90"></a-plane>
            <a-text value="Navigating markets.  The COVID-19 outbreak has created an 'overnight' global shutdown without precedent, and without much certainty as to its resolution."
                    color="black" rotation="-90 0 0" position="-1.2 0 2.5" scale="0.5 0.5 0.5"></a-text>

            <a-image image2="url: https://www.ubs.com" src="#image002" rotation="-90 0 0" position="0 -0.2 4" width="3"
                     height="2"></a-image>

            <a-plane color="white" rotation="-90 0 0" position="0 -0.2 5.5" width="3" height="0.8"
                     material="transparent: true; opacity: 0.90"></a-plane>
            <a-text value="Panorama webinar: A short, sharp shock or prolonged pain? Our investment experts forecast potential market opportunities in a post COVID-19 world."
                    color="black" rotation="-90 0 0" position="-1.2 0 5.5" scale="0.5 0.5 0.5"></a-text>

			<!-- Right Column -->

        </a-marker>
        </entity>
</a-scene>
</body>
<script>
    // Get the User Preferences
    async function getPrefs(userID) {
        // We cannot call to the Admin System so we will call to a static set of parameters instead
        //const id_url = 'http://willnnotdan.github.io/business-card/?userID='+userID;
        const id_url = 'https://willnnotdan.github.io/business-card/dummy-params.json';
        const res = await getUser(id_url);
        // update the Assets
        document.getElementById("image001").setAttribute("src", res.images[0]);
        document.getElementById("image002").setAttribute("src", res.images[1]);
        //document.getElementById("video1").setAttribute("src", res.videos[2]);
        document.getElementById("person").setAttribute("src", res.user.image);
        document.getElementById("email").setAttribute("value", res.user.email);

        document.getElementById("emailPlane").addEventListener('click', () => {
            window.open("mailto:" + res.user.email, '_blank');
        });

        document.getElementById("phone").setAttribute("value", res.user.phone);
        document.getElementById("address").setAttribute("value", res.user.address);

        var feed = res.rss[0];
        buildStories(feed);
    }
    getPrefs(userID); // Uncomment this when URL available
</script>
</html>